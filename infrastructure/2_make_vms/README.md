# Создание инстансов для Kubernetes в OpenNebula через Terraform

---

## Введение

Данная документация описывает процесс автоматического создания инстансов для Kubernetes (мастеры и воркеры) в OpenNebula с использованием Terraform. Конфигурация позволяет динамически находить ID сетей и образов по именам, подключать виртуальные машины к различным сетям (frontend и backend) и задавать параметры ресурсов, такие как CPU, память, диски и IP-адреса.

---

## Предварительные требования

### ПО и доступ:
1. **Terraform версии 1.3.0 или выше.**
2. **OpenNebula CLI и API:**
   - Доступ через RPC2 API.
   - Настроенные хосты, образы, сети и шаблоны.

### Настройки OpenNebula:
1. **Образ:**
   - Имя: `Base Ubuntu Server Image` (или аналогичный).
   - Образ должен быть доступен для использования и поддерживать загрузку.

2. **Шаблон:**
   - Имя: `ubuntu_2204_noimage_tf` (или аналогичный).
   - Шаблон не должен содержать дисков, но может включать сетевые настройки и базовые параметры.

3. **Сети:**
   - Настроенные сети:
     - **frontend_net:** сеть для внешнего трафика.
     - **backend_net:** сеть для внутреннего обмена данными между компонентами кластера.
   - Terraform автоматически найдет `id` этих сетей по их именам.

4. **Учетные данные:**
   - **Username и password** для доступа к OpenNebula должны быть сохранены в **Vault**.
   - Используйте следующую команду для добавления учетных данных в Vault:
     ```bash
     vault kv put secret/opennebula username="oneadmin" password="XXX"
     ```
   - Замените `XXX` на ваш реальный пароль.

---

## Конфигурация Terraform

Конфигурация разделена на два файла:

### 1. `main.tf`

Основной файл содержит логику провайдеров, получение данных и описание ресурсов.

---

### 2. `variables.tf`

Файл `variables.tf` содержит определения переменных, чтобы их можно было легко настраивать.

---

## Выполнение конфигурации

1. **Инициализация Terraform:**
   ```bash
   terraform init
   ```

2. **Проверка плана развертывания:**
   ```bash
   terraform plan
   ```

3. **Применение конфигурации:**
   ```bash
   terraform apply
   ```

---

## Проверка развертывания

1. **Проверить созданные виртуальные машины:**
   ```bash
   onevm list
   ```

2. **Убедиться, что машины запущены:**
   ```bash
   onevm show <VM_ID>
   ```

3. **Подключиться к созданным инстансам:**
   Используйте SSH для подключения по заданным IP-адресам.

---

## Заключение

Эта конфигурация позволяет автоматически создавать инстансы для Kubernetes с использованием заранее заданных шаблонов, образов и сетей. Все параметры можно изменять через переменные в `variables.tf`, а учетные данные OpenNebula надежно хранятся в Vault.
